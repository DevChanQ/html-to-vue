import { isNode } from './ast'
import { getOptionsFromNode } from "./helpers";

/**
 * rendering the ast into vue render functions
 * @param {*} ast AST generated by html-parse-stringify
 * @param {*} config our configuration
 * @param {*} createElement vue's createElement
 * @param {*} context vue functional component context
 */
export const renderer = (ast, config, h) => {
  const _render = (node, parent, key, index) => {
    if (Array.isArray(node)) {
      const nodes = []
      // node is an array
      node.forEach((subnode, index) => {
        nodes.push(_render(subnode, node, null, index))
      })
      return nodes
    } else if (isNode(node)) {
      // node is either a node with children or a node or a text node
      if (node.type === 'text') {
        return config.textTransformer(node.content) // return text
      }
      if (node.type === 'tag') {
        const children = []
        node.children.forEach((child, index) => {
          children.push(_render(child, node, null, index))
        })

        // if it's an extra component use custom renderer
        if (typeof config.config.extraComponentsMap[node.name] !== 'undefined') {
          const Component = config.config.extraComponentsMap[node.name];

          return h(
            Component,
            getOptionsFromNode(node),
            () => [...children]
          )
        }

        // else, create normal html element
        return h(
          node.name,
          getOptionsFromNode(node),
          [...children]
        )
      }
    }
  }

  return h("div", {}, _render(ast, null, null, 0))
}